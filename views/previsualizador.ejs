<%- layout('layouts/adminLayout') %>

<div class="container-fluid"> <!-- Añadido container-fluid para consistencia -->
    <!-- Mensajes Flash -->
    <% if (successMessage && successMessage.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <%= successMessage[0] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>
    <% if (errorMessage && errorMessage.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <%= errorMessage[0] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <form action="/admin/previsualizador" method="post" class="mt-3">
        <div class="mb-3"> <!-- Cambiado mb-2 a mb-3 para más espacio -->
            <label for="prompt" class="form-label">Prompt para la IA:</label>
            <textarea class="form-control" id="prompt" name="prompt" rows="5" placeholder="Ej: Crea una landing page simple para una tienda de café llamada 'El Grano Feliz'. Incluye un título, un párrafo de bienvenida y una imagen placeholder."><%= locals.loadedPrompt || '' %></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="sendPromptBtn">Enviar Prompt a IA</button>
        <button type="button" class="btn btn-success ms-2" id="saveCardBtn" style="display: none;">Guardar Tarjeta</button>
    </form>

    <% if (typeof apiResponseData !== 'undefined' && apiResponseData) { %>
        <div class="mt-4">
            <h4>Respuesta de la API (Datos Crudos):</h4>
            <pre><code style="white-space: pre-wrap; word-break: break-all;"><%= JSON.stringify(apiResponseData, null, 2) %></code></pre>
        </div>
    <% } %>

    <div class="mt-4"> 
        <h4>Previsualización:</h4>
        <iframe id="previewIframe" src="<%= locals.previewUrl || 'about:blank' %>" width="100%" height="600px" style="border: 1px solid #ccc;"></iframe>
    </div>
    
    <% if (!locals.previewUrl && !(typeof apiResponseData !== 'undefined' && apiResponseData) && !locals.isNewCard && !locals.editingCard) { %>
        <div class="mt-4 text-center placeholder-content">
             <img src="/images/avatar.svg" alt="Previsualizador" style="width: 200px; opacity: 0.5;">
            <p class="mt-2">La respuesta de la IA o la previsualización aparecerá aquí. Ingresa un prompt para comenzar.</p>
        </div>
    <% } %>
</div>

<!-- Modal para Título de Tarjeta -->
<div class="modal fade" id="cardTitleModal" tabindex="-1" aria-labelledby="cardTitleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardTitleModalLabel">Guardar Tarjeta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="saveCardForm">
          <div class="mb-3">
            <label for="cardTitleInput" class="form-label">Título de la Tarjeta</label>
            <input type="text" class="form-control" id="cardTitleInput" name="title" required value="<%= locals.editingCard ? editingCard.title : '' %>">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmSaveCardBtn">Confirmar y Guardar</button>
      </div>
    </div>
  </div>
</div>

<% block('pageScripts').append('<script src="/js/admin-previsualizador.js"></script>') %>